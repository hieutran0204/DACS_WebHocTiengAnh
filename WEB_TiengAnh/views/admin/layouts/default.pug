extends ../../layouts/default

block title
  | Quản lý đề thi - Admin

block content
  .container-fluid.py-4
    //- Chỉ hiển thị thông báo khi có biến success hoặc error được truyền vào
    if (success && success.length > 0)
      .alert.alert-success.alert-dismissible.fade.show(role='alert')
        | #{success}
        button(type='button', class='btn-close', data-bs-dismiss='alert', aria-label='Close')
    if (error && error.length > 0)
      .alert.alert-danger.alert-dismissible.fade.show(role='alert')
        | #{error}
        button(type='button', class='btn-close', data-bs-dismiss='alert', aria-label='Close')

    .row.mb-4
      .col-12
        .card.shadow
          .card-header.bg-primary.text-white
            .d-flex.justify-content-between.align-items-center
              h4.mb-0 Danh sách đề thi
              a.btn.btn-light(href='/admin/exam-parts/create')
                i.bi.bi-plus-circle.me-2
                | Tạo đề thi mới

    .row
      .col-12
        .card.shadow
          .card-body.p-0
            if examParts.length
              .table-responsive
                table.table.table-hover.align-middle.mb-0#exam-parts-table
                  thead.bg-light
                    tr
                      th.text-center(style="width: 50px") STT
                      th.text-center Loại đề
                      th.text-center Phần thi
                      th.text-center Số câu hỏi
                      th.text-center Trạng thái
                      th.text-center Độ khó
                      th.text-center Người tạo
                      th.text-center Ngày tạo
                      th.text-center(style="width: 150px") Hành động
                  tbody
                    each examPart, index in examParts
                      tr
                        td.text-center #{index + 1}
                        td.text-center #{examPart.examType}
                        td.text-center
                          span.badge(class={
                            'bg-info': examPart.part === 1 || examPart.part === 5,
                            'bg-primary': examPart.part === 2,
                            'bg-warning text-dark': examPart.part === 3 || examPart.part === 6,
                            'bg-success': examPart.part === 4 || examPart.part === 7
                          }) Part #{examPart.part}
                        td.text-center #{examPart.questions.length}
                        td.text-center
                          span.badge(class={
                            'bg-secondary': examPart.status === 'draft',
                            'bg-success': examPart.status === 'public'
                          }) #{examPart.status === 'draft' ? 'Nháp' : 'Công khai'}
                        td.text-center
                          span.badge(class={
                            'bg-success': examPart.difficulty === 0,
                            'bg-warning text-dark': examPart.difficulty === 1,
                            'bg-danger': examPart.difficulty === 2
                          }) #{examPart.difficulty === 0 ? 'Dễ' : examPart.difficulty === 1 ? 'Trung bình' : 'Khó'}
                        td.text-center #{examPart.createdBy ? examPart.createdBy.username : 'N/A'}
                        td.text-center #{examPart.createdAt ? examPart.createdAt.toLocaleString('vi-VN') : 'N/A'}
                        td.text-center
                          .btn-group(role="group")
                            a.btn.btn-sm.btn-outline-primary.rounded-start(href=`/admin/exam-parts/edit/${examPart._id}`, title="Chỉnh sửa")
                              i.bi.bi-pencil
                            form.d-inline(method='POST', action=`/admin/exam-parts/${examPart._id}?_method=DELETE`)
                              button.btn.btn-sm.btn-outline-danger.rounded-end(type='submit', title="Xóa", onclick="return confirm('Bạn có chắc chắn muốn xóa đề thi này?')")
                                i.bi.bi-trash
                            if examPart.status === 'draft'
                              form.d-inline(method='POST', action=`/admin/exam-parts/${examPart._id}/publish`)
                                button.btn.btn-sm.btn-outline-success.ms-1(type='submit', title="Công khai")
                                  i.bi.bi-check-circle

            else
              .text-center.py-5
                i.bi.bi-question-circle.display-4.text-muted
                h4.mt-3.text-muted Không có đề thi nào
                p.text-muted Hãy tạo đề thi mới để bắt đầu
                a.btn.btn-primary.mt-3(href='/admin/exam-parts/create')
                  i.bi.bi-plus-circle.me-2
                  | Tạo đề thi

block scripts
  script.
    $(document).ready(function() {
      $('#exam-parts-table thead tr').clone(true).appendTo('#exam-parts-table thead');
      $('#exam-parts-table thead tr:eq(1) th').each(function(i) {
        if (i !== 8) { // Bỏ qua cột hành động
          var title = $(this).text();
          $(this).html('<input type="text" class="form-control form-control-sm" placeholder="Tìm ' + title + '" />');
          $('input', this).on('keyup change', function() {
            if (table.column(i).search() !== this.value) {
              table.column(i).search(this.value).draw();
            }
          });
        } else {
          $(this).empty();
        }
      });

      const table = $('#exam-parts-table').DataTable({
        dom: '<"top d-flex justify-content-between align-items-center"Bf>rt<"bottom d-flex justify-content-between align-items-center mt-3"lip>',
        buttons: [
          {
            extend: 'copy',
            className: 'btn btn-sm btn-outline-secondary',
            text: '<i class="bi bi-clipboard"></i> Copy'
          },
          {
            extend: 'excel',
            className: 'btn btn-sm btn-outline-success',
            text: '<i class="bi bi-file-excel"></i> Excel'
          },
          {
            extend: 'pdf',
            className: 'btn btn-sm btn-outline-danger',
            text: '<i class="bi bi-file-pdf"></i> PDF'
          },
          {
            extend: 'print',
            className: 'btn btn-sm btn-outline-primary',
            text: '<i class="bi bi-printer"></i> Print'
          }
        ],
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
        },
        responsive: true,
        orderCellsTop: true,
        fixedHeader: true,
        columnDefs: [
          { targets: [0, 1, 2, 3, 6, 8], orderable: false },
          { targets: 7, type: 'date' }
        ],
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        initComplete: function() {
          $('.dt-buttons .btn').removeClass('btn-secondary');
        }
      });
    });

  style.
    .card {
      border: none;
      border-radius: 10px;
    }
    .card-header {
      border-radius: 10px 10px 0 0 !important;
    }
    .badge {
      font-size: 0.8rem;
      padding: 0.35em 0.65em;
      font-weight: 500;
    }
    .table th, .table td {
      vertical-align: middle;
      white-space: normal;
    }
    .table th {
      white-space: nowrap;
    }