extends ../layouts/default

block content
  .container.mt-5
    h1.text-center.mb-4 Đề thi Listening TOEIC
    if !examParts.length
      p.text-center Không có đề thi Listening nào được public.
    else
      each examPart in examParts
        .card.mb-4
          .card-header.bg-primary.text-white
            h2 Đề #{examPart._id} - Part #{examPart.part.join(', ')} (Độ khó: #{difficultyMap[examPart.difficulty]})
          .card-body
            form(action='/toeic/listening/submit' method='POST')
              input(type='hidden' name='examPartId' value=examPart._id)
              each question, index in examPart.questions
                .question.mb-3
                  if question.questionId
                    p.mb-2
                      strong Câu #{index + 1}: 
                      | #{question.questionId.questionText || 'Không có câu hỏi'}
                    if question.questionId.audioUrl
                      .mb-3
                        audio(controls class='w-100')
                          source(src=question.questionId.audioUrl type='audio/mpeg')
                          | Trình duyệt của bạn không hỗ trợ phát audio.
                    if question.questionId.options && Array.isArray(question.questionId.options)
                      each option, optIndex in question.questionId.options
                        .form-check
                          label.form-check-label
                            input.form-check-input(type='radio' name=`answers[${index}]` value=optIndex required)
                            |  #{option}
                    else
                      p.text-warning (Không có lựa chọn đáp án)
                  else
                    p.text-danger Câu #{index + 1}: (Câu hỏi không tồn tại)
              .timer.mb-3
                p Thời gian còn lại: 
                  span#timer.text-primary 00:00
              button.btn.btn-primary(type='submit') Nộp bài

  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')
  script.
    // Timer logic
    let time = 1800; // 30 phút (1800 giây)
    const timerDisplay = document.getElementById('timer');
    const countdown = setInterval(() => {
      const minutes = Math.floor(time / 60);
      const seconds = time % 60;
      timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      time--;
      if (time < 0) {
        clearInterval(countdown);
        timerDisplay.textContent = 'Hết giờ!';
        document.querySelector('form').submit(); // Tự động nộp bài khi hết giờ
      }
    }, 1000);