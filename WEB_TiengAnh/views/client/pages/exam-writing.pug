extends ../layouts/default

block content
  h1.text-center.text-primary.mt-4.mb-3 ƒê·ªÅ thi Writing TOEIC: #{writing.examCode}
  p#timer.text-center.text-danger.font-weight-bold.mb-4 Th·ªùi gian c√≤n l·∫°i: 60:00

  if error
    p.alert.alert-danger.text-center= error
  if success
    p.alert.alert-success.text-center= success

  form#examForm(action=`/testtoeic/writing/${writing._id}/submit` method="POST" enctype="multipart/form-data")
    each question, index in writing.questions
      .card.mb-4.shadow-sm
        .card-body
          h4.card-title C√¢u h·ªèi #{index + 1} (Part #{question.part})
          
          if question.part === 8
            img.img-fluid.mb-3(src=question.part8.img alt="H√¨nh ·∫£nh c√¢u h·ªèi")
            p.text-muted
              | T·ª´ kh√≥a: 
              span.badge.badge-info= question.part8.keyword1
              | , 
              span.badge.badge-info= question.part8.keyword2
            textarea.form-control(name=`answers[${index}][text]` rows="5" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." required oninput=`updateWordCount(${index})`)
            input.form-control-file.mt-2(type="file" name=`answers[${index}][file]` accept="image/*")
            p.text-right.text-muted.mt-1.word-count(id="word-count-#{index}") S·ªë t·ª´: 0

          else if question.part === 9
            p.font-weight-bold T√¨nh hu·ªëng:
            p.text-muted= question.part9.situation
            p.font-weight-bold Y√™u c·∫ßu:
            p.text-muted= question.part9.requirements
            textarea.form-control(name=`answers[${index}][text]` rows="10" placeholder="Nh·∫≠p email..." required oninput=`updateWordCount(${index})`)
            p.text-right.text-muted.mt-1.word-count(id="word-count-#{index}") S·ªë t·ª´: 0

          else if question.part === 10
            p.font-weight-bold ƒê·ªÅ b√†i:
            p.text-muted= question.part10.question
            textarea.form-control(name=`answers[${index}][text]` rows="15" placeholder="Nh·∫≠p b√†i lu·∫≠n..." required oninput=`updateWordCount(${index})`)
            p.text-right.text-muted.mt-1.word-count(id="word-count-#{index}") S·ªë t·ª´: 0

    .text-center.mt-4
      button.btn.btn-lg.btn-success(type="submit") üìù N·ªôp b√†i

  style.
    .card-title {
      font-weight: bold;
      color: #2c3e50;
    }
    .word-count {
      font-style: italic;
      font-size: 0.9em;
    }
    .form-control:focus {
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      border-color: #80bdff;
    }

  script.
    function updateWordCount(index) {
      const textarea = document.querySelector(`textarea[name="answers[${index}][text]"]`);
      const wordCount = textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length;
      document.querySelector(`#word-count-${index}`).textContent = `S·ªë t·ª´: ${wordCount}`;
    }

    // ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (60 ph√∫t)
    let timeLeft = 60 * 60; // 60 ph√∫t t√≠nh b·∫±ng gi√¢y
    const timerElement = document.getElementById('timer');
    const form = document.getElementById('examForm');
    
    const countdown = setInterval(() => {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `Th·ªùi gian c√≤n l·∫°i: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      if (timeLeft <= 0) {
        clearInterval(countdown);
        alert('H·∫øt th·ªùi gian l√†m b√†i!');
        form.submit();
      }
      
      timeLeft--;
    }, 1000);
